pipeline {
  agent {
    kubernetes {
      label 'deploy-master'
      defaultContainer 'kubectl'
      namespace 'soa-microservices'
      serviceAccount 'master-deployer'
    }
  }

  environment {
    EUREKA_DEPLOY_JOB = 'SOA-Deploy'
    USER_SOA_DEPLOY_JOB = 'UserSOA-Deploy'
    CHAT_SOA_DEPLOY_JOB = 'ChatSOA-Deploy'
    ENGAGEMENT_SOA_DEPLOY_JOB = 'EngagementSOA-Deploy'
  }

  stages {
    stage('Deploy Eureka Server') {
      steps {
        echo "Lancement du déploiement Eureka Server"
        build job: "${EUREKA_DEPLOY_JOB}", parameters: [
          string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
          string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
        ], wait: true
      }
    }

    stage('Deploy Other Services') {
      parallel {
        stage('Deploy UserSOA') {
          steps {
            echo "Lancement du déploiement UserSOA"
            build job: "${USER_SOA_DEPLOY_JOB}", parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ], wait: true
          }
        }
        stage('Deploy ChatSOA') {
          steps {
            echo "Lancement du déploiement ChatSOA"
            build job: "${CHAT_SOA_DEPLOY_JOB}", parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ], wait: true
          }
        }
        stage('Deploy EngagementSOA') {
          steps {
            echo "Lancement du déploiement EngagementSOA"
            build job: "${ENGAGEMENT_SOA_DEPLOY_JOB}", parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ], wait: true
          }
        }
      }
    }
  }

  post {
    success {
      echo "Déploiement de tous les services terminé avec succès"
    }
    failure {
      echo "Échec du déploiement d'un ou plusieurs services"
    }
  }
}