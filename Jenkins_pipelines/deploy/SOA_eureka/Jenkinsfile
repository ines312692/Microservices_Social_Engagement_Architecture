pipeline {
  agent {
    kubernetes {
      inheritFrom 'deploy-eureka'
      defaultContainer 'helm'
      namespace 'soa-microservices'
      serviceAccount 'eureka-deployer'
    }
  }

  environment {
    RELEASE_NAME = 'eureka-service'
    CHART_PATH = 'helm_charts/eureka-server'
    NAMESPACE = 'soa-microservices'
    IMAGE_TAG = "${BUILD_NUMBER}-${GIT_COMMIT.take(7)}"
    DOCKERHUB_USERNAME = 'inestmimi123'
    IMAGE_NAME = 'eureka-service'
  }

  stages {
    stage('Helm Upgrade') {
      steps {
        container('helm') {
          script {
            try {
              sh """
                helm upgrade --install ${RELEASE_NAME} ${CHART_PATH} \
                  --namespace ${NAMESPACE} \
                  --set image.repository=${DOCKERHUB_USERNAME}/${IMAGE_NAME} \
                  --set image.tag=${IMAGE_TAG}
              """
            } catch (Exception e) {
              echo "Erreur dans le stage 'Helm Upgrade' : ${e.message}"
              error("Échec du déploiement Helm")
            }
          }
        }
      }
    }
  }

  post {
    success {
      echo "Déploiement réussi pour EurekaSOA"
    }
    failure {
      echo "Échec du déploiement pour EurekaSOA"
    }
  }
}
