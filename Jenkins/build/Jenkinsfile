pipeline {
  agent {
    kubernetes {
      inheritFrom 'build-master'
      defaultContainer 'jenkins-agent'
      namespace 'soa-microservices'
      serviceAccount 'master-deployer'
    }
  }
  environment {
      EUREKA_BUILD_JOB = 'SOA-Build'
      USER_SOA_BUILD_JOB = 'UserSOA-Build'
      CHAT_SOA_BUILD_JOB = 'ChatSOA-Build'
      ENGAGEMENT_SOA_BUILD_JOB = 'EngagementSOA-Build'
    }

  stages {
    stage('Trigger Service Builds') {
      parallel {
        stage('Trigger Eureka Build') {
          steps {
            build job: 'SOA-Build', parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ]
          }
        }
        stage('Trigger UserSOA Build') {
          steps {
            build job: 'UserSOA-Build', parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ]
          }
        }
        stage('Trigger ChatSOA Build') {
          steps {
            build job: 'ChatSOA-Build', parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ]
          }
        }
        stage('Trigger EngagementSOA Build') {
          steps {
            build job: 'EngagementSOA-Build', parameters: [
              string(name: 'BUILD_NUMBER', value: "${BUILD_NUMBER}"),
              string(name: 'GIT_COMMIT', value: "${GIT_COMMIT}")
            ]
          }
        }
      }
    }
  }

  post {
    success {
      echo "Tous les builds des services (Eureka, UserSOA, ChatSOA, EngagementSOA) ont été déclenchés avec succès"
    }
    failure {
      echo "Échec du déclenchement d'un ou plusieurs builds"
    }
  }
}